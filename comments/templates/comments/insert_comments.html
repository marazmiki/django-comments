{% load i18n comments_tags %}
{% if comments_enabled %}
    <h1>Insert comments for object {{ object }}</h1>
    <hr />

    {% get_comments_list for object as comments %}
    <ul id="comments">
        {% for comment in comments %}
            {% include "comments/item.html" %}
        {% endfor %}
    </ul>
    <h2>{% trans "Post new comment" %}</h2>
    <div id="form-placeholder">
        {% include "comments/form.html" %}
    </div>
    <script type="text/javascript"{# src="{{ MEDIA_URL }}comments/js/comments.js" #}>
var CommentsHandler = function(){
    var defaultFormAction;
    var formPostComment = $('#form-post-comment');
    var formPlaceholder = $('#form-placeholder');
    var commentsList = $('#comments');
    var submitButtons;

    var insertComment = function(html, comment_id, parent_id) {
        if (parent_id) {
            $('#comment-'+parent_id).after(html);
        } else {
            commentsList.append(html);
        }
        window.location.hash = 'comment-'+comment_id;
    }

    var setHandlers = function(){
        defaultFormAction = formPostComment.attr('action');
        submitButtons = formPostComment.find(':submit');

        $('#comments li a.button-reply').live('click', function(){
            var link  = $(this);
            var comment = link.closest('li');
            $('ul.errorlist', formPostComment).remove();
            comment.append(formPostComment);
            formPostComment.attr('action', link.attr('href'));
            formPostComment.find('textarea').focus();
            return false;
        });

        formPostComment.submit(function(e){
            formPostComment.addClass('in-progress');
            submitButtons.attr('disabled', 'disabled');

            $('ul.errorlist', formPostComment).remove();
            $.ajax({
                type     : 'post',
                dataType : 'json',
                data     : formPostComment.serialize(),
                url      : formPostComment.attr('action'),
                success  : function(json, status, xhr){
                    if (json.success) {
                        insertComment(json.comment, json.comment_id, json.parent_id);
                        formPostComment.attr(defaultFormAction);
                        formPostComment.find('textarea').val('');
                        formPlaceholder.append(formPostComment);
                    } else {
                        for (var e in json.errors) {
                            $('#id_'+e, formPostComment).closest('li')
                                .prepend(json.errors[e]);
                        }
                    }
                },
                complete : function(xhr, status){
                    // if (status != 'success') { alert(status); }
                    //submitButton.removeAttr('disabled');
                    formPostComment.removeClass('in-progress');
                    submitButtons.removeAttr('disabled');
                }
            });

            return false;
        });
    }

    return {
        init: function(){
            setHandlers();
        }
    }
}
    </script>
    <script type="text/javascript">CommentsHandler().init();</script>
{% else %}
    <h1>{% trans "Commenting is disabled" %}</h1>
{% endif %}
